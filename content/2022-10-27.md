+++
title = "Part 3: Static Docker Registry in Rust"
slug = "static-docker-registry-in-rust-part-3"
date = 2022-10-27
draft = true

[taxonomies]
tags = ["rust","zarf","docker-registry"]
+++

Part 3 of a multi-part series on writing a static Docker registry in Rust.

<!-- more -->

## Pulling the Manifest

Per the API spec, this route looks like:

```text
GET /v2/<name>/manifests/<reference>
```

where `name` is the name of the image (statically `registry` in this case), and `reference` is the tag of the image (in this case we dont care what `reference` is, we will only be serving one image for every reference).

Checking this endpoint with cURL:

```bash
docker tag registry:2.8.1 localhost:666/registry:2.8.1
docker push localhost:666/registry:2.8.1

$ curl localhost:666/v2/registry/manifests/2.8.1

# truncated example
{
   "name": <name>,
   "tag": <tag>,
   "fsLayers": [
      {
         "blobSum": <digest>
      },
      ...
    ]
   ],
   "history": <v1 images>,
   "signature": <JWS>
}
```

By default, the Docker registry is going to provide a v1 manifest. We can force it to provide a v2 manifest by setting the `Accept` header to `application/vnd.docker.distribution.manifest.v2+json`:

```bash
$ curl localhost:666/v2/registry/manifests/2.8.1 -H "Accept: application/vnd.docker.distribution.manifest.v2+json"

# truncated v2 example
{
  "schemaVersion": 2,
  "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
  "config": {
    "mediaType": "application/vnd.docker.container.image.v1+json",
    "size": 4139,
    "digest": "sha256:02bcf88391173d5ffd5cc5542c0d3335124607bfe16f11d07bbbfcafd2348059"
  },
  "layers": [
    {
      "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
      "size": <int>,
      "digest": "sha256:<some digest>"
    },
    ...
  ]
}
```

v1 is basically dead, and I really didn't feel like supporting it, so for every request to `/v2/registry/manifests/<reference>`, we will return a v2 manifest.

But wait, we dont have a v2 manifest!  We have a Crane manifest from our `seed-image.tar` [Crane tarball format](https://github.com/google/go-containerregistry/blob/main/pkg/v1/tarball/README.md).

```bash
mkdir -p mnt/init
mkdir -p mnt/registry-rust

# unpack init package into mnt
tar --use-compress-program=unzstd -xvf zarf-init-{ARCH}-{VERSION}.tar.zst -C mnt/init

# unpack seed-image.tar into mnt/registry-rust
tar -xvf mnt/init/seed-image.tar -C mnt/registry-rust

$ ls -l mnt/registry-rust

Permissions Size User   Date Modified Name
.rw-r--r--   369 razzle 31 Dec  1969  03bbf04a79081d9f1f6cca63e9480201759523dd8129c33a90fa103740dada3b.tar.gz
.rw-r--r--  2.7M razzle 31 Dec  1969  9b18e9b68314027565b90ff6189d65942c0f7986da80df008b8431276885218e.tar.gz
.rw-r--r--   214 razzle 31 Dec  1969  27c60cee15e894d66ba4a00568a27b094f725197640e58d81129d9241a13b2ee.tar.gz
.rw-r--r--  5.5M razzle 31 Dec  1969  cb556f39845e9506e3500b5bb5e74c696935b5b3d729bb5c7121ba9a420ded8c.tar.gz
.rw-r--r--  285k razzle 31 Dec  1969  d32db5db73116c723916b5df8f4ecc82d84f63f631c631d3fb81997d2fac11e9.tar.gz
.rw-r--r--   497 razzle 31 Dec  1969  manifest.json
.rw-r--r--  4.1k razzle 31 Dec  1969  sha256:02bcf88391173d5ffd5cc5542c0d3335124607bfe16f11d07bbbfcafd2348059

# and the manifest.json
$ cat mnt/registry-rust/manifest.json | jq

[
  {
    "Config": "sha256:02bcf88391173d5ffd5cc5542c0d3335124607bfe16f11d07bbbfcafd2348059",
    "RepoTags": [
      "registry:2.8.1"
    ],
    "Layers": [
      "9b18e9b68314027565b90ff6189d65942c0f7986da80df008b8431276885218e.tar.gz",
      "d32db5db73116c723916b5df8f4ecc82d84f63f631c631d3fb81997d2fac11e9.tar.gz",
      "cb556f39845e9506e3500b5bb5e74c696935b5b3d729bb5c7121ba9a420ded8c.tar.gz",
      "03bbf04a79081d9f1f6cca63e9480201759523dd8129c33a90fa103740dada3b.tar.gz",
      "27c60cee15e894d66ba4a00568a27b094f725197640e58d81129d9241a13b2ee.tar.gz"
    ]
  }
]
```

What Now Airman?

## Translating Crane to v2

So now we need to write a translation layer between this Crane manifest to a v2 manifest.  This is where the [`oci-spec`](https://github.com/containers/oci-spec-rs) crate comes in.  We can use this crate to create a v2 manifest from the Crane manifest.

```rust
// content abridged for brevity
```
