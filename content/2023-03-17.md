+++
title = "20,000 Layers Under the Sea"
slug = "20000-layers-under-the-sea"
date = 2023-03-17
draft = true

[taxonomies]
tags = ["zarf","oci"]
+++

> tldr; If you care not for the story of a man slowly losing his mind, disregard this post.

<!-- more -->

## Phase 0: The Problem

To set the stage, publishing / storing Zarf packages within Docker registries is a concept the Zarf team had been kicking around for a while and
in early January it became a critical feature request due to UDS needing a "package manager". The initial details of this request can be found in [this discussion](https://github.com/defenseunicorns/zarf/discussions/1298).
I volunteered to take on the task of understanding + implementing the interaction between Zarf and OCI compliant registries (due to my previous experience [re-designing Zarf's Rust injector system](https://github.com/defenseunicorns/zarf/pull/948)).

There were a few things I knew going in:

- Publishing will need to work with every registry compliant with the [OCI Distribution Spec](https://github.com/opencontainers/distribution-spec)
- cosign/helm were already tools that were capable of publishing non images to registries
- Publishing would need authentication
- Publishing would need to be able to handle large layers (potentially 10+ GB/layer) (_looking at you, Kubevirt_)
- Published packages would need to be able to be pulled/deployed/inspected after the fact

### Phase 1: Research

The first thing I did was re-read the [OCI Manifest Spec](https://github.com/opencontainers/image-spec/blob/main/manifest.md) and [OCI Artifact Spec](https://github.com/opencontainers/image-spec/blob/main/artifact.md) to re-familiarize myself with what actually goes into an image and artifact respectively (yes there is a substantial difference between an OCI image and an OCI artifact).

Following this, I looked at the tools that exist today that I knew were doing something similar to what I was trying to accomplish, cosign and helm. After a cursory look ath their imports, I discovered they were both using [ORAs](https://oras.land), a low-level CLI + Go library for interacting with OCI registries.

- ecr
- oras/cosign/helm
- auth
- progressbar / multispinner
- breaking the branch
- syft bug
- integrations w/ new package structure
- testing lous
- testing 200+ layers

- compose
